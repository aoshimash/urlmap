# JavaScript レンダリング アーキテクチャ

## システム構成

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   CLI Command   │───▶│  Unified Client │───▶│  SPA Detector   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                        │
                                ▼                        ▼
                       ┌─────────────────┐    ┌─────────────────┐
                       │   HTTP Client   │    │   JS Client     │
                       │   (Resty)       │    │ (Playwright-Go) │
                       └─────────────────┘    └─────────────────┘
                                                        │
                                                        ▼
                                               ┌─────────────────┐
                                               │  Browser Pool   │
                                               │ ┌─────┐ ┌─────┐ │
                                               │ │ Br1 │ │ Br2 │ │
                                               │ └─────┘ └─────┘ │
                                               └─────────────────┘
```

## 主要コンポーネント

### 1. SPA Detector (`internal/detector/`)

**役割**: サイトがSPAかどうかを自動判定

**手法**:
- **静的解析**: HTML構造、フレームワーク検出、リンク数分析
- **動的検証**: JavaScript実行前後のリンク数比較

**精度**: 90%以上

**実装ファイル**:
- `spa_detector.go`: メイン検出ロジック
- `cache.go`: 検出結果キャッシュ

### 2. Browser Pool (`internal/client/browser_pool.go`)

**役割**: ブラウザインスタンスの効率的な管理

**最適化**:
- インスタンス再利用
- コンテキスト共有
- メモリ使用量制御

**制限**: メモリ使用量とのバランス

### 3. Render Cache (`internal/cache/render_cache.go`)

**役割**: レンダリング結果のキャッシュ

**戦略**:
- LRU（Least Recently Used）アルゴリズム
- TTL（Time To Live）機能
- 並行アクセス対応

**効果**: 50-90%の処理時間短縮

### 4. Performance Metrics (`internal/metrics/js_metrics.go`)

**役割**: パフォーマンス指標の収集と分析

**収集項目**:
- レンダリング統計（回数、時間、エラー率）
- キャッシュ統計（ヒット率、ミス率）
- ブラウザプール統計
- 並行処理統計
- メモリ使用量監視

### 5. Optimized JS Client (`internal/client/optimized_js_client.go`)

**役割**: 最適化されたJavaScriptレンダリングクライアント

**機能**:
- ブラウザプール統合
- レンダリングキャッシュ統合
- 並行処理制御
- リソースブロッキング
- ドメインベースのコンテキスト再利用

## データフロー

### 1. 自動検出フロー

```
1. URL受信
   ↓
2. 静的解析（HTML構造分析）
   ↓
3. フレームワーク検出
   ↓
4. リンク数分析
   ↓
5. 動的検証（JS実行前後比較）
   ↓
6. 判定結果キャッシュ
   ↓
7. 適切なクライアント選択
```

### 2. レンダリングフロー

```
1. URL受信
   ↓
2. キャッシュチェック
   ↓
3. ブラウザプールからコンテキスト取得
   ↓
4. ページ最適化（リソースブロック等）
   ↓
5. JavaScript実行
   ↓
6. HTML抽出
   ↓
7. 結果キャッシュ
   ↓
8. コンテキスト返却
```

## パフォーマンス最適化

### 1. ブラウザプール

**目的**: ブラウザインスタンスの効率的な管理

**実装**:
- プールサイズ制限（デフォルト: 3）
- コンテキスト再利用
- 自動クリーンアップ

**効果**: 起動時間の大幅短縮

### 2. レンダリングキャッシュ

**目的**: 同じページの再レンダリングを回避

**実装**:
- LRUアルゴリズム
- TTL機能（デフォルト: 1時間）
- 並行アクセス対応

**効果**: キャッシュヒット時 <100ms

### 3. 並行処理

**目的**: 複数ページの同時処理

**実装**:
- ワーカープール（デフォルト: 5）
- セマフォ制御
- エラーハンドリング

**効果**: 5-10 pages/秒

### 4. リソースブロッキング

**目的**: 不要なリソースの読み込みをブロック

**対象**:
- 画像（jpg, png, gif, webp）
- CSS（css）
- フォント（woff, woff2, ttf）

**効果**: ページ読み込み時間の短縮

## エラーハンドリング

### 1. ブラウザ起動エラー

**原因**: システム依存関係不足
**対処**: Dockerコンテナ使用を推奨

### 2. タイムアウトエラー

**原因**: ページ読み込み時間超過
**対処**: タイムアウト設定の調整

### 3. メモリ不足エラー

**原因**: ブラウザプールサイズ過大
**対処**: プールサイズの削減

### 4. ネットワークエラー

**原因**: 外部リソース読み込み失敗
**対処**: フォールバック機能の活用

## 設定パラメータ

### ブラウザ設定

| パラメータ | 説明 | デフォルト |
|------------|------|------------|
| `BrowserType` | ブラウザタイプ | chromium |
| `Headless` | ヘッドレスモード | true |
| `Timeout` | ページ読み込みタイムアウト | 30s |
| `WaitFor` | 待機条件 | networkidle |

### パフォーマンス設定

| パラメータ | 説明 | デフォルト |
|------------|------|------------|
| `PoolSize` | ブラウザプールサイズ | 3 |
| `Workers` | 並列ワーカー数 | 5 |
| `CacheSize` | キャッシュサイズ | 1000 |
| `CacheTTL` | キャッシュTTL | 1h |

### 検出設定

| パラメータ | 説明 | デフォルト |
|------------|------|------------|
| `Threshold` | 自動検出閾値 | 0.3 |
| `StrictMode` | 厳格モード | false |
| `AutoDetect` | 自動検出有効化 | false |

## 監視とメトリクス

### 1. パフォーマンス指標

- **レンダリング時間**: 平均、最大、最小
- **キャッシュヒット率**: ヒット数/総リクエスト数
- **エラー率**: エラー数/総リクエスト数
- **メモリ使用量**: 現在値、ピーク値

### 2. ブラウザプール指標

- **アクティブコンテキスト数**: 現在使用中のコンテキスト数
- **プール使用率**: アクティブ数/最大数
- **コンテキスト作成数**: 新規作成されたコンテキスト数
- **コンテキスト再利用数**: 再利用されたコンテキスト数

### 3. 並行処理指標

- **同時実行数**: 現在並行実行中のタスク数
- **最大同時実行数**: 記録された最大同時実行数
- **ワーカー使用率**: アクティブワーカー数/総ワーカー数

## セキュリティ考慮事項

### 1. サンドボックス

- ブラウザはサンドボックス環境で実行
- システムリソースへのアクセス制限
- ネットワークアクセスの制御

### 2. リソース制限

- メモリ使用量の監視
- CPU使用率の制限
- ディスク使用量の制御

### 3. ネットワーク制御

- リクエスト数の制限
- タイムアウト設定
- エラー時の適切な処理

## 将来の拡張

### 1. 追加ブラウザサポート

- Safari（WebKit）
- Edge（Chromium）
- カスタムブラウザ

### 2. 高度な最適化

- プリロード機能
- 予測キャッシュ
- 分散キャッシュ

### 3. 監視機能強化

- リアルタイムメトリクス
- アラート機能
- ログ分析
